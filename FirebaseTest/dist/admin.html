<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <!-- Import Firebase CDN -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
        import { getFirestore, collection, getDocs, doc, setDoc, getDoc, deleteDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC-K6Hfx5jrTvnilwha29ceKov0PC2kII0",
            authDomain: "pre-advisingdb.firebaseapp.com",
            projectId: "pre-advisingdb",
            storageBucket: "pre-advisingdb.appspot.com",
            messagingSenderId: "879799797410",
            appId: "1:879799797410:web:9a52fbf15ce59b8bda39fb",
            measurementId: "G-MSMWJ52KBW"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let originalCourses;

        // Populate curriculum and course dropdowns
            async function populateDropdowns() {
                try {
                    // Populate curriculum dropdowns
                    const curriculumSelectElements = document.querySelectorAll('.curriculum-dropdown');
                    const curriculumColRef = collection(db, 'Curriculum');
                    const curriculumSnapshot = await getDocs(curriculumColRef);
                    curriculumSnapshot.forEach((doc) => {
                        curriculumSelectElements.forEach((select) => {
                            const option = document.createElement('option');
                            option.value = doc.id;
                            option.textContent = doc.data().curriculumName;
                            select.appendChild(option);
                        });
                    });

                    // Populate course dropdown
                    const courseSelect = document.getElementById('curriculum-course');
                    curriculumSnapshot.forEach((doc) => {
                        const curriculumData = doc.data();
                        const option = document.createElement('option');
                        option.value = curriculumData.curriculumCourse;
                        option.textContent = curriculumData.curriculumCourse;
                        courseSelect.appendChild(option);
                    });

                    // Store original courses
                    originalCourses = document.getElementById('curriculum-course');
                } catch (error) {
                    console.error('Error populating dropdowns:', error);
                }
            }

            // Add event listener for Add New Course button
            document.getElementById('add-course-btn').addEventListener('click', () => {
                const courseSelect = document.getElementById('curriculum-course');
                courseSelect.style.display = 'none';
                const inputField = document.createElement('input');
                inputField.type = 'text';
                inputField.id = 'new-course-input';
                inputField.placeholder = 'Enter new course';
                courseSelect.replaceWith(inputField);
            });

            // Add event listener for Save Course button
            document.getElementById('save-course-btn').addEventListener('click', async () => {
                try {
                    const newCourseName = document.getElementById('new-course-name').value;
                    const newCourseRef = doc(db, 'Courses', newCourseName);
                    await setDoc(newCourseRef, { courseName: newCourseName });
                    alert('Course added successfully!');
                    document.getElementById('add-course-modal').style.display = 'none';
                    populateCourseDropdown(); // Update course dropdown
                } catch (error) {
                    console.error('Error adding course:', error);
                    alert('Error adding course: ' + error.message);
                }
            });

            // Add event listener for Cancel Course button
            document.getElementById('cancel-course-btn').addEventListener('click', () => {
                const inputField = document.getElementById('new-course-input');
                inputField.replaceWith(originalCourses);
                originalCourses.style.display = 'block';
                document.getElementById('add-course-modal').style.display = 'none';
            });

            // Run this when the page loads
            window.onload = populateDropdowns;

        // Add event listener for Add New Course button
        document.getElementById('add-course-btn').addEventListener('click', () => {
            document.getElementById('add-course-modal').style.display = 'block';
        });

        
        

        // Add event listener for Cancel Course button
        document.getElementById('cancel-course-btn').addEventListener('click', () => {
            document.getElementById('add-course-modal').style.display = 'none';
        });

        // Create Curriculum Functionality
            document.getElementById('show-add-subject-form').addEventListener('click', async (e) => {
                e.preventDefault();
                const curriculumCode = document.getElementById('curriculum-Code').value;
                const curriculumName = document.getElementById('curriculum-name').value;
                const curriculumTitle = document.getElementById('curriculum-title').value;
                let curriculumCourse;

                const courseElement = document.getElementById('curriculum-course');
                if (courseElement && courseElement.tagName === 'INPUT') {
                    curriculumCourse = courseElement.value;
                } else if (courseElement) {
                    curriculumCourse = courseElement.value;
                } else {
                    const newCourseInput = document.getElementById('new-course-input');
                    curriculumCourse = newCourseInput.value;
                }

                const curriculumStartYear = document.getElementById('curriculum-start-year').value;
                const curriculumEndYear = document.getElementById('curriculum-end-year').value;

                try {
                    const curriculumRef = doc(db, 'Curriculum', curriculumCode);
                    const curriculumSnapshot = await getDoc(curriculumRef);

                    if (curriculumSnapshot.exists()) {
                        const response = confirm('Curriculum already exists. Update existing data?');
                        if (response) {
                            // Update existing curriculum (only changed fields)
                            await updateDoc(curriculumRef, {
                                curriculumName: curriculumName !== curriculumSnapshot.data().curriculumName ? curriculumName : curriculumSnapshot.data().curriculumName,
                                curriculumTitle: curriculumTitle !== curriculumSnapshot.data().curriculumTitle ? curriculumTitle : curriculumSnapshot.data().curriculumTitle,
                                curriculumCourse: curriculumCourse !== curriculumSnapshot.data().curriculumCourse ? curriculumCourse : curriculumSnapshot.data().curriculumCourse,
                                curriculumStartYear: curriculumStartYear !== curriculumSnapshot.data().curriculumStartYear ? curriculumStartYear : curriculumSnapshot.data().curriculumStartYear,
                                curriculumEndYear: curriculumEndYear !== curriculumSnapshot.data().curriculumEndYear ? curriculumEndYear : curriculumSnapshot.data().curriculumEndYear,
                            });
                            alert('Curriculum updated successfully!');
                        } else {
                            // Cancel update
                            alert('Update cancelled.');
                            return;
                        }
                    } else {
                        // Add new curriculum
                        await setDoc(curriculumRef, {
                            curriculumCode,
                            curriculumName,
                            curriculumTitle,
                            curriculumCourse,
                            curriculumStartYear,
                            curriculumEndYear,
                            subjects: {}
                        });
                        alert('Curriculum added successfully!');
                        document.querySelector('#add-subject-form form').reset(); // Reset form after submission
                    }
                } catch (error) {
                    console.error('Error adding/updating curriculum:', error);
                    alert('Error adding/updating curriculum: ' + error.message);
                }
            });
            
        // Add Subject Functionality
        document.getElementById('add-subject').addEventListener('click', async (e) => {
  e.preventDefault();
  const curriculumId = document.getElementById('subject-curriculum-id').value;
  const year = document.getElementById('subject-year').value;
  const semester = document.getElementById('subject-semester').value;
  const subjectId = document.getElementById('subject-id').value;
  const subjectName = document.getElementById('subject-name').value;
  const prerequisites = document.getElementById('subject-prerequisites').value.split(',');
  const lec = document.getElementById('subject-lec').value;
  const labUnit = document.getElementById('subject-lab-unit').value;
  const totalUnits = parseInt(lec) + parseInt(labUnit);

  // Automatically calculate total units
  document.getElementById('total-units').value = totalUnits;

  try {
    const curriculumRef = doc(db, 'Curriculum', curriculumId);
    const curriculumSnapshot = await getDoc(curriculumRef);

    if (curriculumSnapshot.exists()) {
      const existingData = curriculumSnapshot.data();
      const isFinalized = existingData.finalized;

      if (!isFinalized) {
        const existingSubjects = existingData.subjects || {};

        // Add new subject
        if (!existingSubjects[year]) {
          existingSubjects[year] = {};
        }
        if (!existingSubjects[year][semester]) {
          existingSubjects[year][semester] = [];
        }
        existingSubjects[year][semester].push({
          subjectId,
          subjectName,
          prerequisites,
          lec,
          labUnit,
          totalUnits
        });

        // Update Firestore with the modified subjects
        await setDoc(curriculumRef, { subjects: existingSubjects }, { merge: true });
        alert('Subject added successfully!');
        document.getElementById('subject-form').reset(); // Reset form after submission
      } else {
        alert('Cannot add subjects to finalized curriculum.');
      }
    } else {
      alert('Curriculum does not exist.');
    }
  } catch (error) {
    console.error('Error adding subject:', error);
    alert('Error adding subject: ' + error.message);
  }
});

       // Search Curriculum Functionality
document.getElementById('search-curriculum-input').addEventListener('input', async (e) => {
    try {
        const searchQuery = e.target.value.toLowerCase();
        const curriculumColRef = collection(db, 'Curriculum');
        const curriculumSnapshot = await getDocs(curriculumColRef);
        const curriculumOptions = [];

        curriculumSnapshot.forEach((doc) => {
            const curriculumData = doc.data();
            const curriculumName = curriculumData.curriculumName.toLowerCase();
            const curriculumId = doc.id;

            if (curriculumName.includes(searchQuery)) {
                curriculumOptions.push({
                    curriculumId,
                    curriculumName,
                    course: curriculumData.curriculumCourse,
                    year: curriculumData.curriculumStartYear,
                    semester: curriculumData.curriculumEndYear,
                    subjects: curriculumData.subjects,
                });
            }
        });

        // Display Curriculum Options
        const curriculumTableBody = document.getElementById('curriculum-table-body');
        curriculumTableBody.innerHTML = '';

        curriculumOptions.forEach((curriculum) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${curriculum.curriculumId}</td>
                <td>${curriculum.curriculumName}</td>
                <td>${curriculum.course}</td>
                <td>${curriculum.year}</td>
                <td>${curriculum.semester}</td>
                <td>
                    <button class="view-subjects-btn" data-curriculum-id="${curriculum.curriculumId}">View Subjects</button>
                    <button id="finalize-curriculum-btn" style="background-color: #4CAF50; color: #fff; border: none; border-radius: 5px; cursor: pointer;">Finalize Curriculum</button>
                </td>
            `;
            curriculumTableBody.appendChild(row);
        });
    } catch (error) {
        console.error('Error searching curriculum:', error);
    }
});



// View Subjects Functionality
document.addEventListener('click', async (e) => {
    if (e.target.classList.contains('view-subjects-btn')) {
        try {
            const curriculumId = e.target.dataset.curriculumId;
            const curriculumRef = doc(db, 'Curriculum', curriculumId);
            const curriculumSnapshot = await getDoc(curriculumRef);
            const curriculumData = curriculumSnapshot.data();
            const subjects = curriculumData.subjects;

            // Display Subjects Table
            const subjectsTableContainer = document.getElementById('subjects-table-container');
            subjectsTableContainer.innerHTML = `
                <h3>Subjects for ${curriculumData.curriculumName}</h3>
                <table id="subjects-table">
                    <thead>
                        <tr>
                            <th>Subject ID</th>
                            <th>Subject Name</th>
                            <th>Year</th>
                            <th>Semester</th>
                            <th>Pre-Requisites</th>
                            <th>LEC</th>
                            <th>Lab Unit</th>
                            <th>Total Units</th>
                        </tr>
                    </thead>
                    <tbody id="subjects-table-body">
                    </tbody>
                </table>
            `;

        // Display Subjects Data
const subjectsTableBody = document.getElementById('subjects-table-body');
subjectsTableBody.innerHTML = '';

Object.keys(subjects).forEach((year) => {
  Object.keys(subjects[year]).forEach((semester) => {
    subjects[year][semester].forEach((subject) => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${subject.subjectId}</td>
        <td>${subject.subjectName}</td>
        <td>${year === '1' ? '1st Year' : year === '2' ? '2nd Year' : year === '3' ? '3rd Year' : '4th Year'}</td>
        <td>${semester === '1' ? '1st Semester' : '2nd Semester'}</td>
        <td>${Array.isArray(subject.preReq) ? subject.preReq.join(', ') : 'None'}</td>
        <td>${subject.lec}</td>
        <td>${subject.labUnit}</td>
        <td>${subject.totalUnits}</td>
      `;
      subjectsTableBody.appendChild(row);
    });
  });
});
        } catch (error) {
            console.error('Error viewing subjects:', error);
        }
    }
});
// Hide the add subject button by default
const addSubjectBtn = document.getElementById('add-subject-btn');
if (addSubjectBtn) {
    addSubjectBtn.style.display = 'none';
}

// Check if subjects table container is empty on page load
if (document.getElementById('subjects-table-container').innerHTML.trim() !== '') {
    console.log('Subjects table container is not empty on page load');
    const addSubjectBtn = document.getElementById('add-subject-btn');
    if (addSubjectBtn) {
        addSubjectBtn.style.display = 'block'; // Show the Add Subject button when not empty
    }
} else {
    console.log('Subjects table container is empty on page load');
    const addSubjectBtn = document.getElementById('add-subject-btn');
    if (addSubjectBtn) {
        addSubjectBtn.style.display = 'none'; // Hide the Add Subject button when empty
    }
}

// Add event listener to the view subject button
const viewSubjectBtn = document.getElementById('view-subject-btn');
if (viewSubjectBtn) {
    viewSubjectBtn.addEventListener('click', () => {
        console.log('View subject button clicked');
        const addSubjectBtn = document.getElementById('add-subject-btn');
        if (addSubjectBtn) {
            if (document.getElementById('subjects-table-container').innerHTML.trim() !== '') {
                addSubjectBtn.style.display = 'block';
            }
        }
    });
} else {
    console.log('View subject button not found');
}

window.addEventListener('DOMContentLoaded', () => {
  // Finalize curriculum button event listener
  const finalizeBtn = document.getElementById('finalize-curriculum-btn');
  
  if (finalizeBtn) {
    finalizeBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      
      // Confirm finalize action
      const confirmFinalize = confirm('Are you sure you want to finalize the curriculum? This will lock all subjects and prevent further changes.');
      
      if (confirmFinalize) {
        try {
          // Lock curriculum logic here
          await lockCurriculum();
          alert('Curriculum finalized successfully!');
          // Disable add/update buttons
          document.getElementById('add-subject-btn').disabled = true;
          document.getElementById('update-subject-btn').disabled = true;
        } catch (error) {
          console.error('Error finalizing curriculum:', error);
          alert('Error finalizing curriculum: ' + error.message);
        }
      }
    });
  } else {
    console.error('Finalize button not found.');
  }
  
  // Lock curriculum function
  async function lockCurriculum() {
    const curriculumId = getCurriculumId();
    const curriculumRef = doc(db, 'Curriculum', curriculumId);
    await updateDoc(curriculumRef, { finalized: true });
  }
});

// Search Curriculum Functionality
document.getElementById('search-curriculum-input').addEventListener('input', async (e) => {
  try {
    const searchQuery = e.target.value.toLowerCase();
    const curriculumColRef = collection(db, 'Curriculum');
    const curriculumSnapshot = await getDocs(curriculumColRef);
    const curriculumOptions = [];
    
    curriculumSnapshot.forEach((doc) => {
      const curriculumData = doc.data();
      const curriculumName = curriculumData.curriculumName.toLowerCase();
      const curriculumId = doc.id;
      
      if (curriculumName.includes(searchQuery)) {
        curriculumOptions.push({
          curriculumId,
          curriculumName,
          course: curriculumData.curriculumCourse,
          year: curriculumData.curriculumStartYear,
          semester: curriculumData.curriculumEndYear,
          subjects: curriculumData.subjects,
        });
      }
    });
    
    // Display Curriculum Options
    const curriculumTableBody = document.getElementById('curriculum-table-body');
    curriculumTableBody.innerHTML = '';
    
    curriculumOptions.forEach((curriculum) => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${curriculum.curriculumId}</td>
        <td>${curriculum.curriculumName}</td>
        <td>${curriculum.course}</td>
        <td>${curriculum.year}</td>
        <td>${curriculum.semester}</td>
        <td>
          <button class="view-subjects-btn" data-curriculum-id="${curriculum.curriculumId}">View Subjects</button>
          <button class="finalize-curriculum-btn" data-curriculum-id="${curriculum.curriculumId}">Finalize Curriculum</button>
        </td>
      `;
      curriculumTableBody.appendChild(row);
    });
    
    // Dynamic finalize button event listener
    const finalizeButtons = document.querySelectorAll('.finalize-curriculum-btn');
    
    finalizeButtons.forEach((button) => {
      button.addEventListener('click', async (e) => {
        e.preventDefault();
        const curriculumId = e.target.dataset.curriculumId;
        const confirmFinalize = confirm('Are you sure?');
        
        if (confirmFinalize) {
          try {
            await lockCurriculum(curriculumId);
            alert('Curriculum finalized!');
          } catch (error) {
            console.error('Error finalizing curriculum:', error);
          }
        }
      });
    });
  } catch (error) {
    console.error('Error searching curriculum:', error);
  }
});

// Lock curriculum function
async function lockCurriculum(curriculumId) {
  const curriculumRef = doc(db, 'Curriculum', curriculumId);
  await updateDoc(curriculumRef, { finalized: true });
}
// Get the current year
const currentYear = new Date().getFullYear();

// Populate the curriculum start year dropdown
for (let year = currentYear; year >= currentYear - 10; year--) {
    const option = document.createElement('option');
    option.value = year;
    option.textContent = year;
    document.getElementById('curriculum-start-year').appendChild(option);
}

// Populate the curriculum end year dropdown
for (let year = currentYear; year >= currentYear - 10; year--) {
    const option = document.createElement('option');
    option.value = year;
    option.textContent = year;
    document.getElementById('curriculum-end-year').appendChild(option);
}

// Add event listener to curriculum start year dropdown
document.getElementById('curriculum-start-year').addEventListener('change', (e) => {
    const startYear = parseInt(e.target.value);
    const endYearSelect = document.getElementById('curriculum-end-year');

    // Remove existing options
    while (endYearSelect.options.length > 1) {
        endYearSelect.remove(1);
    }

    // Populate end year options based on start year
    for (let year = startYear; year <= currentYear; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        endYearSelect.appendChild(option);
    }
});

// Get the add subject button and form
const addSubjectForm = document.getElementById('add-subject-form');

// Initialize selectedCurriculum variable
let selectedCurriculum = '';
let curriculumId = '';

// Add event listener to the curriculum table
document.getElementById('curriculum-table-body').addEventListener('click', (e) => {
    if (e.target.tagName === 'TD') {
        const curriculumRow = e.target.parentNode;
        selectedCurriculum = curriculumRow.textContent;
        curriculumId = curriculumRow.cells[0].textContent; // Update curriculumId
        document.getElementById('curriculum-content-container').style.display = 'block';
        if (selectedCurriculum) {
            document.getElementById('add-subject-btn').style.display = 'block';
        } else {
            document.getElementById('add-subject-btn').style.display = 'none';
        }

        // Populate subjects table container
        const subjectsTableContainer = document.getElementById('subjects-table-container');
        subjectsTableContainer.innerHTML = ''; // Clear the container

        // Get the updated curriculum content data from Firestore
        const curriculumRef = doc(db, 'Curriculum', curriculumId);
        getDoc(curriculumRef).then(curriculumSnapshot => {
            if (curriculumSnapshot.exists()) {
                const existingData = curriculumSnapshot.data();
                const existingSubjects = existingData.subjects || {};

                // Create table header
                const tableHeader = document.createElement('div');
                tableHeader.innerHTML = `
                    <h3>Curriculum Content</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Curriculum</th>
                                <th>Subject ID</th>
                                <th>Subject Name</th>
                                <th>Year</th>
                                <th>Semester</th>
                                <th>LEC</th>
                                <th>Lab Unit</th>
                                <th>Pre-Req</th>
                                <th>Total Units</th>
                            </tr>
                        </thead>
                        <tbody id="curriculum-content-table-body">
                        </tbody>
                    </table>
                `;
                subjectsTableContainer.appendChild(tableHeader);

                // Loop through each year and semester
                for (const year in existingSubjects) {
                    for (const semester in existingSubjects[year]) {
                        // Loop through each subject
                        for (const subject of existingSubjects[year][semester]) {
                            const curriculumContentRow = document.createElement('tr');

                            const curriculumCell = document.createElement('td');
                            curriculumCell.textContent = selectedCurriculum;
                            curriculumContentRow.appendChild(curriculumCell);

                            const subjectIdCell = document.createElement('td');
                            subjectIdCell.textContent = subject.subjectId;
                            curriculumContentRow.appendChild(subjectIdCell);

                            const subjectNameCell = document.createElement('td');
                            subjectNameCell.textContent = subject.subjectName;
                            curriculumContentRow.appendChild(subjectNameCell);

                            const yearCell = document.createElement('td');
                            yearCell.textContent = year;
                            curriculumContentRow.appendChild(yearCell);

                            const semesterCell = document.createElement('td');
                            semesterCell.textContent = semester === '1' ? '1st Semester' : '2nd Semester';
                            curriculumContentRow.appendChild(semesterCell);

                            const lecCell = document.createElement('td');
                            lecCell.textContent = subject.lec;
                            curriculumContentRow.appendChild(lecCell);

                            const labUnitCell = document.createElement('td');
                            labUnitCell.textContent = subject.labUnit;
                            curriculumContentRow.appendChild(labUnitCell);

                            const preReqCell = document.createElement('td');
                            preReqCell.textContent = subject.preReq.join(', '); // Display pre-requisites as comma-separated list
                            curriculumContentRow.appendChild(preReqCell);

                            const totalUnitsCell = document.createElement('td');
                            totalUnitsCell.textContent = subject.totalUnits;
                            curriculumContentRow.appendChild(totalUnitsCell);

                            document.getElementById('curriculum-content-table-body').appendChild(curriculumContentRow);
                        }
                    }
                }
            }
        }).catch(error => {
            console.error('Error:', error);
        });
    }
});

// Add event listener to hide button when no curriculum is selected
document.addEventListener('click', (e) => {
    if (!selectedCurriculum || e.target.id === 'curriculum-table-body') {
        return;
    }
    if (e.target.tagName !== 'TD' && !e.target.closest('#curriculum-table-body')) {
        selectedCurriculum = '';
        document.getElementById('add-subject-btn').style.display = 'none';
        document.getElementById('curriculum-content-container').style.display = 'none';
    }
});

// Create a MutationObserver instance
const observer = new MutationObserver(() => {
    console.log('Subjects table container modified');
    if (document.getElementById('subjects-table-container').innerHTML.trim() === '') {
        console.log('Subjects table container is empty');
        const addSubjectBtn = document.getElementById('add-subject-btn');
        if (addSubjectBtn) {
            addSubjectBtn.style.display = 'none'; // Hide the Add Subject button when empty
        }
    } else {
        console.log('Subjects table container is not empty');
        const addSubjectBtn = document.getElementById('add-subject-btn');
        if (addSubjectBtn) {
            addSubjectBtn.style.display = 'block'; // Show the Add Subject button when not empty
        }
    }
});

// Observe the subjects table container
observer.observe(document.getElementById('subjects-table-container'), {
    childList: true,
    subtree: true
});

// Add event listener to the add subject button
document.getElementById('add-subject-btn').addEventListener('click', () => {
    // Display the add subject form
    addSubjectForm.style.display = 'block';
});

// Add event listener to the close add subject form button
document.getElementById('close-add-subject-form').addEventListener('click', () => {
    // Hide the add subject form
    addSubjectForm.style.display = 'none';
});

// Add event listener to the cancel add subject button
document.getElementById('cancel-add-subject-btn').addEventListener('click', () => {
    // Hide the add subject form
    addSubjectForm.style.display = 'none';
});

// Get the subject ID select element
const subjectIdSelect = document.querySelector('#floatingsubject-id');

// Get all the documents in the "Curriculum" collection
const curriculumCollectionRef = collection(db, 'Curriculum');
getDocs(curriculumCollectionRef)
  .then(querySnapshot => {
    subjectIdSelect.innerHTML = ''; // Clear previous options
    const allSubjects = []; // Store all subjects
    querySnapshot.forEach((doc, index) => {
      console.log(`Document ${index}:`, doc.data());
      const curriculumData = doc.data();
      if (curriculumData.subjects) {
        console.log('Subjects:', curriculumData.subjects);
        Object.keys(curriculumData.subjects).forEach(year => {
          Object.keys(curriculumData.subjects[year]).forEach(semester => {
            curriculumData.subjects[year][semester].forEach(subject => {
              allSubjects.push(subject); // Add subject to array
            });
          });
        });
      }
    });

    // Remove duplicate subjects
    const uniqueSubjects = [...new Map(allSubjects.map(subject => [subject.subjectId, subject])).values()];

    // Populate subject ID select element
    uniqueSubjects.forEach(subject => {
      const option = document.createElement('option');
      option.value = subject.subjectId;
      option.text = subject.subjectId;
      subjectIdSelect.appendChild(option);
    });
  })
  .catch(error => {
    console.error('Error:', error);
  });

// Add event listener to manual subject button
document.getElementById('manual-subject-btn').addEventListener('click', (e) => {
  console.log('Manual subject button clicked');
  
  document.getElementById('floatingsubject-id').style.display = 'none';
  document.getElementById('manual-subject-id-input').style.display = 'block';
  document.getElementById('manual-subject-btn').style.display = 'none';
  document.getElementById('cancel-manual-subject-btn').style.display = 'block';
  
  const elements = [
    'floatingyear',
    'floatingsemester',
    'floatingsubject-name',
    'floatingpre-req',
    'floatinglec',
    'floatinglab'
  ];
  
  elements.forEach((id) => {
    const element = document.getElementById(id);
    if (element) {
      element.disabled = false;
    } else {
      console.warn(`Element with ID '${id}' not found.`);
    }
  });
});

document.getElementById('cancel-manual-subject-btn').addEventListener('click', (e) => {
  console.log('Cancel manual subject button clicked');
  
  document.getElementById('floatingsubject-id').style.display = 'block';
  document.getElementById('manual-subject-id-input').style.display = 'none';
  document.getElementById('manual-subject-btn').style.display = 'block';
  document.getElementById('cancel-manual-subject-btn').style.display = 'none';
  
  const elements = [
    'floatingyear',
    'floatingsemester',
    'floatingsubject-name',
    'floatingpre-req',
    'floatinglec',
    'floatinglab'
  ];
  
  elements.forEach((id) => {
    const element = document.getElementById(id);
    if (element) {
      element.disabled = true;
    } else {
      console.warn(`Element with ID '${id}' not found.`);
    }
  });
});
// Add event listener for subject ID select element
subjectIdSelect.addEventListener('change', async () => {
  console.log('Event listener executed');
  const selectedSubjectId = subjectIdSelect.value;
  const curriculumCollectionRef = collection(db, 'Curriculum');
  const querySnapshot = await getDocs(curriculumCollectionRef);
  let selectedSubject;

  querySnapshot.forEach(doc => {
    const curriculumData = doc.data();
    if (curriculumData.subjects) {
      Object.keys(curriculumData.subjects).forEach(year => {
        Object.keys(curriculumData.subjects[year]).forEach(semester => {
          curriculumData.subjects[year][semester].forEach(subject => {
            if (subject.subjectId === selectedSubjectId) {
              selectedSubject = subject; // Find selected subject
            }
          });
        });
      });
    }
  });

  if (selectedSubject) {
    console.log('Selected subject found:', selectedSubject);
    // Auto-generate subject name, pre-requisites, lecture units, lab units and total units
    const subjectNameInput = document.querySelector('#floatingsubject-name');
    const preReqInput = document.querySelector('#floatingpre-req');
    const lectureUnitsInput = document.querySelector('#floatinglec');
    const labUnitsInput = document.querySelector('#floatinglab');
    const totalUnitsInput = document.querySelector('#floatingtotal-units');
    const yearInput = document.querySelector('#floatingyear');
    const semesterInput = document.querySelector('#floatingsemester');

    console.log('Year input:', yearInput);
    console.log('Semester input:', semesterInput);

    subjectNameInput.value = selectedSubject.subjectName;
    preReqInput.value = selectedSubject.preReq;
    lectureUnitsInput.value = selectedSubject.lec;
    labUnitsInput.value = selectedSubject.labUnit;
    totalUnitsInput.value = selectedSubject.totalUnits;

    console.log('Selected subject year:', selectedSubject.year);
    console.log('Selected subject semester:', selectedSubject.semester);

    if (selectedSubject.year && typeof selectedSubject.year === 'object') {
      yearInput.value = Object.keys(selectedSubject.year)[0];
    } else {
      console.log('Selected subject year is not an object');
      yearInput.value = selectedSubject.year;
    }

    if (selectedSubject.semester && typeof selectedSubject.semester === 'object') {
      semesterInput.value = Object.keys(selectedSubject.semester)[0];
    } else {
      console.log('Selected subject semester is not an object');
      semesterInput.value = selectedSubject.semester;
    }

    // Enable year and semester inputs
    console.log('Disabling year input:', yearInput.disabled);
    yearInput.disabled = false;
    console.log('Year input disabled:', yearInput.disabled);

    console.log('Disabling semester input:', semesterInput.disabled);
    semesterInput.disabled = false;
    console.log('Semester input disabled:', semesterInput.disabled);
  } else {
    console.log('No selected subject found');
  }
});

// Add event listener to the save subject button
document.getElementById('save-subject-btn').addEventListener('click', async (e) => {
  e.preventDefault();
  
  let subjectId;
  
  const manualSubjectIdInput = document.getElementById('manual-subject-id-input');
  const floatingSubjectIdSelect = document.getElementById('floatingsubject-id');
  
  if (manualSubjectIdInput.style.display === 'block') {
    subjectId = manualSubjectIdInput.value;
  } else {
    subjectId = floatingSubjectIdSelect.value;
  }
  
  try {
    const subjectData = await getSubjectData(subjectId); // Pass subjectId
    await saveSubjectData(subjectData);
    await updateCurriculumContentTable();
  } catch (error) {
    console.error('Error saving subject:', error);
    alert('Error saving subject: ' + error.message);
  }
});

// Get subject data from form inputs
async function getSubjectData(subjectId) {
  console.log('Getting subject data...');

  const yearInput = document.getElementById('floatingyear');
  console.log('Year input:', yearInput);
  const year = yearInput?.value;
  if (year === undefined || year === null) {
    throw new Error('Year input value is missing');
  }
  console.log('Year:', year);

  const semesterInput = document.getElementById('floatingsemester');
  console.log('Semester input:', semesterInput);
  const semester = semesterInput?.value;
  if (semester === undefined || semester === null) {
    throw new Error('Semester input value is missing');
  }
  console.log('Semester:', semester);

  const subjectNameInput = document.getElementById('floatingsubject-name');
  console.log('Subject name input:', subjectNameInput);
  const subjectName = subjectNameInput?.value;
  if (subjectName === undefined || subjectName === null) {
    throw new Error('Subject name input value is missing');
  }
  console.log('Subject name:', subjectName);

  const preReqInput = document.getElementById('floatingpre-req');
  console.log('Pre-req input:', preReqInput);
  const preReq = preReqInput?.value;
  if (preReq === undefined || preReq === null) {
    preReq = ''; // Set default value for preReq
  }
  console.log('Pre-req:', preReq);

  const lectureUnitsInput = document.getElementById('floatinglec');
  console.log('Lecture units input:', lectureUnitsInput);
  const lectureUnits = lectureUnitsInput?.value;
  if (lectureUnits === undefined || lectureUnits === null) {
    throw new Error('Lecture units input value is missing');
  }
  console.log('Lecture units:', lectureUnits);

  const laboratoryUnitsInput = document.getElementById('floatinglab');
  console.log('Laboratory units input:', laboratoryUnitsInput);
  const laboratoryUnits = laboratoryUnitsInput?.value;
  if (laboratoryUnits === undefined || laboratoryUnits === null) {
    throw new Error('Laboratory units input value is missing');
  }
  console.log('Laboratory units:', laboratoryUnits);

  const totalUnits = parseInt(lectureUnits) + parseInt(laboratoryUnits);
  console.log('Total units:', totalUnits);

  document.getElementById('floatingtotal-units').value = totalUnits; // Update total units input

  return {
    subjectId,
    year,
    semester,
    subjectName,
    preReq,
    lectureUnits,
    laboratoryUnits,
    totalUnits,
  };
}
// Save subject data to Firestore
async function saveSubjectData(subjectData) {
  const curriculumId = getCurriculumId();
  const curriculumRef = doc(db, 'Curriculum', curriculumId);
  const curriculumSnapshot = await getDoc(curriculumRef);

  if (curriculumSnapshot.exists()) {
    const existingData = curriculumSnapshot.data();
    const isFinalized = existingData.finalized;

    if (!isFinalized) {
      const existingSubjects = existingData.subjects || {};
      let subjectExists = false;

      // Check if subject already exists
      if (existingSubjects[subjectData.year] && existingSubjects[subjectData.year][subjectData.semester === '1st Semester' ? '1' : '2']) {
        existingSubjects[subjectData.year][subjectData.semester === '1st Semester' ? '1' : '2'].forEach((subject) => {
          if (subject.subjectId === subjectData.subjectId) {
            subjectExists = true;
          }
        });
      }

      if (!subjectExists) {
        // Add new subject
        if (!existingSubjects[subjectData.year]) {
          existingSubjects[subjectData.year] = {};
        }
        if (!existingSubjects[subjectData.year][subjectData.semester === '1st Semester' ? '1' : '2']) {
          existingSubjects[subjectData.year][subjectData.semester === '1st Semester' ? '1' : '2'] = [];
        }
        existingSubjects[subjectData.year][subjectData.semester === '1st Semester' ? '1' : '2'].push({
          subjectId: subjectData.subjectId,
          subjectName: subjectData.subjectName,
          preReq: subjectData.preReq === '' ? [''] : subjectData.preReq.split(','),
          lec: subjectData.lectureUnits,
          labUnit: subjectData.laboratoryUnits,
          totalUnits: subjectData.totalUnits,
        });

        await setDoc(curriculumRef, { ...existingData, subjects: existingSubjects }, { merge: true });
        alert('Subject added successfully!');
      } else {
        alert('Subject already exists!');
      }
    } else {
      alert('Cannot add subjects to finalized curriculum.');
      throw new Error('Curriculum is finalized.');
    }
  } else {
    throw new Error('Curriculum does not exist.');
  }
}


// Update curriculum content table
async function updateCurriculumContentTable() {
  const curriculumId = getCurriculumId();
  const curriculumRef = doc(db, 'Curriculum', curriculumId);
  const curriculumSnapshot = await getDoc(curriculumRef);

  if (curriculumSnapshot.exists()) {
    const existingData = curriculumSnapshot.data();
    const existingSubjects = existingData.subjects || {};

    // Create table header
    const tableHeader = document.createElement('div');
    tableHeader.innerHTML = `
      <h3>Curriculum Content</h3>
      <table>
        <thead>
          <tr>
            <th>Curriculum</th>
            <th>Subject ID</th>
            <th>Subject Name</th>
            <th>Year</th>
            <th>Semester</th>
            <th>LEC</th>
            <th>Lab Unit</th>
            <th>Pre-Req</th>
            <th>Total Units</th>
          </tr>
        </thead>
        <tbody id="curriculum-content-table-body">
        </tbody>
      </table>
    `;
    document.getElementById('subjects-table-container').appendChild(tableHeader);

    // Loop through each year and semester
    for (const year in existingSubjects) {
      for (const semester in existingSubjects[year]) {
        // Loop through each subject
        for (const subject of existingSubjects[year][semester]) {
          const curriculumContentRow = document.createElement('tr');

          const curriculumCell = document.createElement('td');
          curriculumCell.textContent = selectedCurriculum;
          curriculumContentRow.appendChild(curriculumCell);

          const subjectIdCell = document.createElement('td');
          subjectIdCell.textContent = subject.subjectId;
          curriculumContentRow.appendChild(subjectIdCell);

          const subjectNameCell = document.createElement('td');
          subjectNameCell.textContent = subject.subjectName;
          curriculumContentRow.appendChild(subjectNameCell);

          const yearCell = document.createElement('td');
          yearCell.textContent = year;
          curriculumContentRow.appendChild(yearCell);

          const semesterCell = document.createElement('td');
          semesterCell.textContent = semester === '1' ? '1st Semester' : '2nd Semester';
          curriculumContentRow.appendChild(semesterCell);

          const lecCell = document.createElement('td');
          lecCell.textContent = subject.lec;
          curriculumContentRow.appendChild(lecCell);

          const labUnitCell = document.createElement('td');
          labUnitCell.textContent = subject.labUnit;
          curriculumContentRow.appendChild(labUnitCell);

          const preReqCell = document.createElement('td');
          preReqCell.textContent = subject.preReq.join(', '); // Display pre-requisites as comma-separated list
          curriculumContentRow.appendChild(preReqCell);

          const totalUnitsCell = document.createElement('td');
          totalUnitsCell.textContent = subject.totalUnits;
          curriculumContentRow.appendChild(totalUnitsCell);

          document.getElementById('curriculum-content-table-body').appendChild(curriculumContentRow);
        }
      }
    }
  } else {
    throw new Error('Curriculum document does not exist.');
  }
}

// Get curriculum ID from selected curriculum row
function getCurriculumId() {
  const selectedCurriculumRow = Array.from(document.querySelectorAll('#curriculum-table-body tr')).find(row => row.textContent.includes(selectedCurriculum));
  if (selectedCurriculumRow) {
    return selectedCurriculumRow.cells[0].textContent;
  } else {
    throw new Error('Selected curriculum row not found');
  }
}
    </script>
</head>

<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Montserrat&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@900&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Bowlby+One+SC&display=swap" rel="stylesheet">
<link rel="stylesheet" href="style.css">

<body>
    <h1>Admin Panel</h1>

    <!-- Link to Admin Students Page -->
    <div class="button-container">
        <button class="normal" onclick="window.location.href='admin_students.html'">Manage Students</button>
    </div>

    <hr>

    <!-- Create Curriculum Section -->
    <h2>Create Curriculum</h2>
    <form id="curriculum-form">
        <label for="curriculum-Code">Curriculum Code:</label>
        <input type="text" id="curriculum-Code" required />

        <label for="curriculum-name">Curriculum Name:</label>
        <input type="text" id="curriculum-name" required />

        <label for="curriculum-title">Curriculum Title:</label>
        <input type="text" id="curriculum-title" required />

        <label for="curriculum-course">Course:</label>
        <select id="curriculum-course" required>
            <option value="">Select Course</option>
            <!-- dynamically populate options from existing courses -->
        </select>
        <input type="text" id="curriculum-course-other" placeholder="Specify course" style="display:none;" />
        <button id="add-course-btn" class="normal">Add New Course</button>
        <button type="button" id="save-course-btn" class="normal">Save</button>
            <button id="cancel-course-btn" class="normal">Cancel</button>

       
        <label for="curriculum-eduyear">Educational Year:</label>
        <label for="curriculum-start-year">From:</label>
        <select id="curriculum-start-year" required>
            <option value="">Select Year</option>
            
          
        </select>
        <label for="curriculum-end-year">To:</label>
        <select id="curriculum-end-year" required>
            <option value="">Select Year</option>
           
          
        </select>

        <button type="button" id="show-add-subject-form">Create Curriculum</button>
    </form>
    
    <hr>

    <h2>Add subject to Curriculum</h2>
    <div id="add-subject-section">
        <div id="add-subject-form-container">
            <form id="subject-form">
                <label for="subject-curriculum-id">Curriculum:</label>
                <select id="subject-curriculum-id" class="curriculum-dropdown" required></select>

                <label for="subject-year">Year:</label>
                <select id="subject-year" required>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                </select>

                <label for="subject-semester">Semester:</label>
                <select id="subject-semester" required>
                    <option value="1">1</option>
                    <option value="2">2</option>
                </select>

                <label for="subject-id">Subject ID:</label>
                <input type="text" id="subject-id" required />

                <label for="subject-name">Subject Name:</label>
                <input type="text" id="subject-name" required />

                <label for="subject-prerequisites">Prerequisites (comma-separated):</label>
                <input type="text" id="subject-prerequisites" />

                <label for="subject-lec">LEC :</label>
                <input type="text" id="subject-lec" />

                <label for="subject-lab-unit">Lab Unit :</label>
                <input type="text" id="subject-lab-unit" />

                <label for="subject-total-units">Total Units:</label>
                <!-- this should be automatic and not editable it should add the LEC + Lab Unit and show that to the total Units field -->
                <input type="number" id="total-units" min="1" required />

                <button type="submit" id="add-subject" class="normal">Add Subject</button>
                <button type="button" id="close-add-subject" class="normal">Cancel</button>
            </form>
            <div>
              <hr>
                <h2>Curriculum Module</h2>
                <div id="curriculum-module">
                    <label>Curriculum Search</label>
                    <div id="search-curriculum">
                        <input type="search" id="search-curriculum-input" placeholder="Search Curriculum...">
                        <button id="add-subject-btn" class="normal">Add Subject</button>
                    </div>
                    <div id="curriculum-table-container">
                        <table id="curriculum-table">
                            <thead>
                                <tr>
                                    <th>Curriculum ID</th>
                                    <th>Curriculum Name</th>
                                    <th>Course</th>
                                    <th>Start Year</th>
                                    <th>End Year</th>
                                    <th>Subjects</th>
                                </tr>
                            </thead>
                            <tbody id="curriculum-table-body">
                            </tbody>
                        </table>
                    </div>
                    <div id="curriculum-content-container" style="margin-top: 40px;">
                        <h3>Curriculum Content</h3>
                        <div id="subjects-table-container">
                           
                        </div>
                    </div>
                </div>
         <!-- Floating form for adding subjects -->
<div id="add-subject-form"
style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #fff; padding: 20px; border: 1px solid #ddd; border-radius: 10px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);">
<div style="display: flex; justify-content: flex-end;">
    <button id="close-add-subject-form"
        style="background-color: transparent; border: none; cursor: pointer;"></button>
</div>
<h3>Add Subject</h3>
<form id="add-subject-form-content">
    <label for="subject-id">Subject ID:</label>
    <select id="floatingsubject-id" name="floatingsubject-id"></select>
    <input type="text" id="manual-subject-id-input" name="manual-subject-id-input" style="display:none;">
    <button id="manual-subject-btn" type="button">Add Manual Subject</button>
    <button id="cancel-manual-subject-btn" type="button" style="display:none;">Cancel Manual Subject</button><br><br>
    <label for="year">Year:</label>
    <select id="floatingyear" name="floatingyear" disabled>
        <option value="1">1st Year</option>
        <option value="2">2nd Year</option>
        <option value="3">3rd Year</option>
        <option value="4">4th Year</option>
    </select><br><br>
    <label for="semester">Semester:</label>
    <select id="floatingsemester" name="floatingsemester" disabled>
        <option value="1st Semester">1st Semester</option>
        <option value="2nd Semester">2nd Semester</option>
    </select><br><br>
    <label for="subject-name">Subject Name:</label>
    <input type="text" id="floatingsubject-name" name="floatingsubject-name" disabled><br><br>
    <label for="pre-req">Pre-requisite:</label>
    <input type="text" id="floatingpre-req" name="floatingpre-req" disabled><br><br>
    <label for="lec">Lecture Units:</label>
    <input type="number" id="floatinglec" name="floatinglec" disabled><br><br>
    <label for="lab">Laboratory Units:</label>
    <input type="number" id="floatinglab" name="floatinglab" disabled><br><br>
    <label for="total-units">Total Units:</label>
    <input type="number" id="floatingtotal-units" name="floatingtotal-units" readonly><br><br>
    <button id="save-subject-btn"
        style="background-color: #4CAF50; color: #fff; border: none; border-radius: 5px; cursor: pointer;">Save
        Subject</button>
    <button id="cancel-add-subject-btn"
        style="background-color: #f44336; color: #fff; border: none; border-radius: 5px; cursor: pointer;">Cancel</button>
</form>
</div>
</body>

</html>